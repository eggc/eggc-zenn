---
title: "Emacs ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãƒ¬ãƒãƒ¼ãƒˆï¼š rspec-toggle-spec-and-target ã®èª¿æ•´"
emoji: "ğŸ”§"
type: "tech"
topics:
  - "emacs"
published: true
published_at: "2022-12-18 00:01"
hugo_date: "2022-12-18T00:01:00+09:00"
tags: ["emacs", "advent-calendar"]
---

ã“ã®è¨˜äº‹ã¯ [Emacs Advent Calendar 2022](https://qiita.com/advent-calendar/2022/emacs) ã® 18 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚


## ã¯ã˜ã‚ã«

æœ¬è¨˜äº‹ã§ã¯ Ruby ã«é–¢é€£ã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã‚ã‚‹ rspec-mode ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚ ãã—ã¦ã€ãã®ä¸ä¾¿ãªã¨ã“ã‚ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸã“ã¨ã‚’ãƒ¬ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ æƒ³å®šèª­è€…ã¯ Emacs ã¨ Ruby ã‚’ä½¿ã£ã¦ã„ã‚‹äººã§ã™ã€‚ ãŸã ã—ã€ãã†ã§ãªã„äººã‚‚èª­ã¿ç‰©ã¨ã—ã¦ã¯æ¥½ã—ã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚ çµè«–ã ã‘çŸ¥ã‚ŠãŸã„æ–¹ã¯ã€èƒŒæ™¯ã¨è§£æ±ºç­–ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã ã‘èª­ã‚“ã§ãã ã•ã„ã€‚


## èƒŒæ™¯

[rspec-mode](https://github.com/pezra/rspec-mode) ã¯ Ruby ã® rspec ã‚’ Emacs ä¸Šã§å®Ÿè¡Œã™ã‚‹æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã™ã€‚ rspec-mode ã«ã¯ãã®ä»–ã«ã‚‚ä¾¿åˆ©ãªæ©Ÿèƒ½ãŒå‚™ã‚ã£ã¦ã„ã¾ã™ã€‚ãã‚ŒãŒä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚

| ã‚­ãƒ¼    | é–¢æ•°                         |
|------- |---------------------------- |
| C-c , t | rspec-toggle-spec-and-target |

ã“ã‚Œã¯ã€ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¨ã€ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡Œãæ¥ã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚ ãŸã¨ãˆã°ä¸‹è¨˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ã¦ã„ã‚‹æ™‚ã« `C-c , t` ã‚’å…¥åŠ›ã™ã‚‹ã¨äº¤äº’ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»å‹•ã—ã¾ã™ã€‚

-   root/models/hoge.rb
-   root/spec/models/hoge\_spec.rb

ã—ã‹ã—ãªãŒã‚‰ã€ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ‘ã‚¹ãŒä¸€è‡´ã—ãªã„ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚ ãŸã¨ãˆã°ã€ç§ã¯ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª `controller/` ã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚³ãƒ¼ãƒ‰ã«å¯¾ã—ã¦ `requests/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã„ã¾ã™ã€‚

-   root/controllers/hoges\_controller.rb
-   root/spec/requests/hoges\_spec.rb

ãƒ•ã‚¡ã‚¤ãƒ«åã‚‚ `hoges_controller` ã¨ `hoges_spec` ã§ã‚ã‚Š `_controller` ã‚’çœç•¥ã—ã¦ã„ã‚‹ãŸã‚å¯¾å¿œãŒå–ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ ã“ã®ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã§ã¯ `rspec-toggle-spec-and-target` ã¯æœŸå¾…é€šã‚Šã«å‹•ä½œã—ã¾ã›ã‚“ã€‚


## èª¿æŸ»

é–¢æ•° `rspec-toggle-spec-and-target` ã«æœŸå¾…ã™ã‚‹æŒ¯ã‚‹èˆã„ã‚’ã•ã›ã‚‹ãŸã‚ã€ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¾ã™ã€‚ ã¾ãšä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€é–¢æ•°ã®ãƒ˜ãƒ«ãƒ—ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

```
M-x describe-function rspec-toggle-spec-and-target
```

ãƒ˜ãƒ«ãƒ—ãƒšãƒ¼ã‚¸ã‹ã‚‰é–¢æ•°å®šç¾©ã®ãƒªãƒ³ã‚¯ã¸ã‚¸ãƒ£ãƒ³ãƒ—ã™ã‚‹ã¨ã€ä¸‹è¨˜ã®ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚

```lisp
(defun rspec-toggle-spec-and-target ()
  "Switch to the spec or the target file for the current buffer.
If the current buffer is visiting a spec file, switches to the
target, otherwise the spec."
  (interactive)
  (find-file (rspec-spec-or-target)))
```

ã“ã‚Œã¯å®Ÿè³ª `rspec-spec-or-target` ã®çµæœå¾—ã‚‰ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’é–‹ã„ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚ ã“ã“ã§å‘¼ã³å‡ºã—ã¦ã„ã‚‹ `rspec-spec-or-target` ã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’ã‚ã¦ã¦ `M-.` ã®å®šç¾©ã‚¸ãƒ£ãƒ³ãƒ—ã§æ¢ç´¢ã—ã¾ã™ã€‚

```lisp
(defun rspec-spec-or-target ()
  (if (rspec-buffer-is-spec-p)
      (rspec-target-file-for (buffer-file-name))
    (rspec-spec-file-for (buffer-file-name))))
```

ã“ã‚Œã‚’ç¹°ã‚Šè¿”ã—ã€2 ã¤ã®é–¢æ•°ãŒãƒ‘ã‚¹å¤‰æ›ã®ã‚³ã‚¢éƒ¨åˆ†ã§ã‚ã‚‹ã“ã¨ã‚’çªãæ­¢ã‚ã¾ã—ãŸã€‚

-   `rspec-targetize-file-name (a-file-name extension)`
-   `rspec-specize-file-name (a-file-name)`

ã¿ãŸã¨ã“ã‚ã€æ–‡å­—åˆ—ã‚’å—ã‘å–ã‚Šã€æ–‡å­—åˆ—ã‚’è¿”ã™ã ã‘ã®ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§ã™ã€‚ ã“ã‚Œãªã‚‰ãƒ‘ãƒƒãƒã‚’å½“ã¦ã‚‹ã®ã‚‚é›£ã—ããªã•ãã†ã§ã™ã€‚


## å®Ÿè£…

Emacs Lisp ã®è¨€èªä»•æ§˜ã«ã¯ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã‚„ `super` ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ ã—ã‹ã—[ã‚¢ãƒ‰ãƒã‚¤ã‚¹](https://ayatakesi.github.io/emacs/24.5/elisp_html/Advice-combinators.html)ã¨ã„ã†æ©Ÿèƒ½ã§ä»£æ›¿ã§ãã¾ã™ã€‚ ä»Šå›ã¯å¼•æ•°ã‚’åŠ å·¥ã—ãŸã‚ã¨ã«ã€å…ƒã®é–¢æ•°ã«å‡¦ç†ã‚’ä»»ã›ã‚‹ãŸã‚ `:filter-args` ã‚’ä½¿ã„ã¾ã™ã€‚ å¼•æ•°ã‚’ãƒªã‚¹ãƒˆåŒ–ã—ã¦å—ã‘æ¸¡ã—ã™ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦å®Ÿè£…ã—ã¾ã™ã€‚ é©å½“ãª lisp ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚Šã€ä¸‹è¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã¾ã—ãŸã€‚

```lisp
(defun rspec-specize-file-name-advice (args)
  "controller ã‹ã‚‰ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ç´¢ã™ã‚‹æ™‚ã« request spec ã«ç§»å‹•ã™ã‚‹ãƒ‘ãƒƒãƒ"
  (let ((file-name (nth 0 args)))
    (setq file-name (string-replace "/controllers/" "/requests/" file-name))
    (setq file-name (string-replace "_controller.rb" ".rb" file-name))
    (list file-name)
  ))

(advice-add 'rspec-specize-file-name :filter-args 'rspec-specize-file-name-advice)

; å‹•ä½œç¢ºèª1 çµæœãŒ ("app/requests/hoge.rb") ã«ãªã£ã¦ã„ã‚Œã° OK
(rspec-specize-file-name-advice '("app/controllers/hoge_controller.rb"))

; å‹•ä½œç¢ºèª2 çµæœãŒ "app/requests/hoge_spec.rb" ã«ãªã£ã¦ã„ã‚Œã° OK
(rspec-specize-file-name "app/controllers/hoge_controller.rb")
```

æœŸå¾…é€šã‚Šå‹•ä½œã™ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚ ã“ã‚Œã§ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«â†’ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ç§»å‹•ã¯å®Œæˆã§ã™ã€‚ é€†å‘ãã®ç§»å‹•ã‚‚å¯èƒ½ã«ã™ã‚‹ãŸã‚ã€è¿½åŠ ã§ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

```lisp
(defun rspec-targetize-file-name-advice (args)
  "request spec ã‹ã‚‰ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ¢ç´¢ã™ã‚‹æ™‚ã« controller ã«ç§»å‹•ã™ã‚‹ãƒ‘ãƒƒãƒ"
  (let ((file-name (nth 0 args)) (extension (nth 1 args)))
    (setq file-name (string-replace "/requests/" "/controllers/" file-name))
    (setq file-name (string-replace "_spec" "_controller" file-name))
    (list file-name extension)
  ))

(advice-add 'rspec-targetize-file-name :filter-args 'rspec-targetize-file-name-advice)

; å‹•ä½œç¢ºèª1 çµæœãŒ ("app/controllers/hoge_controller" "rb") ã«ãªã£ã¦ã„ã‚Œã° OK
(rspec-targetize-file-name-advice '("app/requests/hoge_spec" "rb"))

; å‹•ä½œç¢ºèª2 çµæœãŒ "app/controllers/hoge_controller.rb" ã«ãªã£ã¦ã„ã‚Œã° OK
(rspec-targetize-file-name "app/requests/hoge_spec" "rb")
```

ã“ã‚Œã§ã²ã¨ã¾ãšå®Œæˆã§ã™ã€‚ ç¾åœ¨ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹é–¢æ•°ã¯ãƒ‘ã‚¹ã« \_spec, request, controllers, ã„ãšã‚Œã‹ãŒæ··ã–ã£ã¦ã„ã‚‹ã¨å£Šã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚ ã“ã®ç‚¹ã‚’æ”¹å–„ã™ã‚Œã°ã•ã‚‰ã«å®‰å…¨ã«åˆ©ç”¨ã§ãã¾ã™ã€‚ã¨ã¯ã„ãˆå€‹äººåˆ©ç”¨ã§ã¯ã“ã®ç¨‹åº¦ã®ãƒ‘ãƒƒãƒã§ååˆ†ã¨è€ƒãˆã¾ã—ãŸã€‚


## è§£æ±ºç­–

å‹•ä½œç¢ºèªã¾ã§çµ‚ã‚ã£ãŸã‚‰ init.el ã«æ›¸ãè¾¼ã¿ã¾ã™ã€‚ ç§ã¯ use-package ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã®ã§ä¸‹è¨˜ã®ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

```lisp
(defun rspec-specize-file-name-advice (args)
  "controller ã‹ã‚‰ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ç´¢ã™ã‚‹æ™‚ã« request spec ã«ç§»å‹•ã™ã‚‹ãƒ‘ãƒƒãƒ"
  (let ((file-name (nth 0 args)))
    (setq file-name (string-replace "/controllers/" "/requests/" file-name))
    (setq file-name (string-replace "_controller.rb" ".rb" file-name))
    (list file-name)
    ))

(defun rspec-targetize-file-name-advice (args)
  "request spec ã‹ã‚‰ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ¢ç´¢ã™ã‚‹æ™‚ã« controller ã«ç§»å‹•ã™ã‚‹ãƒ‘ãƒƒãƒ"
  (let ((file-name (nth 0 args)) (extension (nth 1 args)))
    (setq file-name (string-replace "/requests/" "/controllers/" file-name))
    (setq file-name (string-replace "_spec" "_controller" file-name))
    (list file-name extension)
    ))

(use-package rspec-mode
  :config
  (advice-add 'rspec-specize-file-name :filter-args 'rspec-specize-file-name-advice)
  (advice-add 'rspec-targetize-file-name :filter-args 'rspec-targetize-file-name-advice))
```

ä»–ã®è¨­å®šã‚‚å«ã‚ãŸæœ€çµ‚çš„ãªã‚³ãƒ¼ãƒ‰ã¯ [GitHub](https://github.com/eggc/dotemacs2/blob/d8febaea74d7dc987278874dedd76bcb77d4ba2d/lib/eg-ruby.el#L27-L55) ã«ç½®ã„ã¦ã‚ã‚Šã¾ã™ã€‚


## ãŠã‚ã‚Šã«

ä»Šå›ã¯ç§ãŒã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹æ™‚ã®ã‚³ãƒ¼ãƒ‰ã®æ¢ã—æ–¹ã‹ã‚‰å®Ÿè£…ã¾ã§ã‚’ç´¹ä»‹ã—ã¦ã¿ã¾ã—ãŸã€‚ å®Ÿã®ã¨ã“ã‚ã€ã“ã‚Œã‚’å®Ÿç¾ã—ã¦å¾—ã‚‰ã‚Œã‚‹æˆæœã¯ãã“ã¾ã§å¤§ããã‚ã‚Šã¾ã›ã‚“ã€‚ ã“ã®ãƒ‘ãƒƒãƒã‚’ä½¿ã£ã¦ç¯€ç´„ã§ãã‚‹æ™‚é–“ã¯ 1 å›ã‚ãŸã‚Š 5 ç§’ç¨‹åº¦ã§ã™ã€‚ æ¦‚ç®—ã§ 150 æ—¥ãã‚‰ã„ä½¿ã„ç¶šã‘ã‚Œã°å…ƒãŒå–ã‚Œã‚‹ç›®ç®—ã§ã™ãŒã€ãã®ç¨‹åº¦ã®æ”¹å–„ã§ã—ã‹ã‚ã‚Šã¾ã›ã‚“ã€‚ ãã‚Œã§ã‚‚ã“ã†ã—ã¦æ™‚é–“ã‚’å‰²ã„ã¦ã„ã‚‹ã®ã¯ã€é“å…·ã‚’æ‰‹å…¥ã‚Œã—ã€ç ”ãæ¾„ã¾ã›ã‚‹ã“ã¨ãŒæ¥½ã—ã„ã‹ã‚‰ã§ã™ã€‚

ä»Šå›ãƒ¬ãƒãƒ¼ãƒˆã—ãŸå†…å®¹ã¯ç§å€‹äººãŒãªã‚“ã¨ãªããã†ã—ã¦ã„ã‚‹ã¨ã„ã†æ‰‹é †ã«ã™ãã¾ã›ã‚“ã€‚ ã‚‚ã£ã¨è‰¯ã„é€²ã‚æ–¹ãŒã‚ã‚‹ã¯ãšã§ã™ã€‚ ä½•ã‹æ°—ã¥ã„ãŸã“ã¨ãŒã‚ã‚Šã¾ã—ãŸã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã„ãŸã ã‘ã‚Œã°å¹¸ã„ã§ã™ã€‚
