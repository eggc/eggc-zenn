---
title: "RSpec ã«ãŠã‘ã‚‹ Flaky Test ã®ä¿®æ­£æ–¹æ³•"
emoji: "ğŸ”"
type: "tech"
topics:
  - "rspec"
published: true
published_at: "2025-02-10 23:59"
hugo_date: "2025-02-10T23:59:00+09:00"
---

## ã¯ã˜ã‚ã«

Flaky Testï¼ˆä¸å®‰å®šãªãƒ†ã‚¹ãƒˆï¼‰ã¨ã¯ã€åŒã˜ã‚³ãƒ¼ãƒ‰ã«å¯¾ã—ã¦å®Ÿè¡Œã™ã‚‹ãŸã³ã«çµæœãŒå¤‰ã‚ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹ãƒ†ã‚¹ãƒˆã‚’æŒ‡ã—ã¾ã™ã€‚ãƒªãƒˆãƒ©ã‚¤ã‚’ç¹°ã‚Šè¿”ã—ã¦ã„ã‚Œã°æˆåŠŸã™ã‚‹ã®ã§ã€è¦‹é€ƒã•ã‚Œã¦ã—ã¾ã†ã“ã¨ã‚‚å¤šã„ã¨æ€ã„ã¾ã™ã€‚å†ç¾ã•ã›ã‚‹ã®ã‚‚é›£ã—ã„ã®ã§ã€é€²ã‚“ã§èª¿æŸ»ã™ã‚‹äººã‚‚ã‚ã¾ã‚Šã„ã¾ã›ã‚“ã€‚ã—ã‹ã—ã€CI ã‚’å›ã™ã®ã«ã‚‚ãŠé‡‘ãŒã‹ã‹ã‚Šã¾ã™ã—ã€å¾…ã¤æ™‚é–“ã‚‚ã‚³ã‚¹ãƒˆã§ã™ã€‚ç´ æ—©ãæ”¹å–„ã™ã‚‹ã“ã¨ãŒæœ›ã¾ã—ã„ã§ã™ã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€ç§ãŒé­é‡ã—ãŸä¸­ã§ã‚‚ç°¡å˜ãª Flaky Test ã‚’å–ã‚Šä¸Šã’ã¦ã€ãã®æ”¹å–„æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚ã¾ã  Flaky Test ã®ä¿®æ­£ã‚’ã—ãŸã“ã¨ãŒãªã„æ–¹ã®å‚è€ƒã«ãªã‚‹ã‚ˆã†ã«ã€å…·ä½“çš„ãªã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ç¤ºã—ãªãŒã‚‰ã€ã‚†ã£ãã‚Šèª¬æ˜ã—ã¦ã„ã¾ã™ã€‚

## äº‹ä¾‹1ï¼šå®šæ•°ã®å†å®šç¾©
### ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰

ä»¥ä¸‹ã¯ Flaky Test ã‚’å«ã‚€ã‚³ãƒ¼ãƒ‰ã®ä¾‹ã§ã™ã€‚äºŒã¤ã®ã‚¯ãƒ©ã‚¹ Loader, Writer ã¨ãã‚Œãã‚Œã®ãƒ†ã‚¹ãƒˆãŒã‚ã‚Šã¾ã™ã€‚Loader, Writer ã®æ©Ÿèƒ½ã¯ã•ã»ã©é‡è¦ã§ã¯ãªã„ãŸã‚ã€ã‹ãªã‚Šç°¡ç•¥åŒ–ã—ã¦ã„ã¾ã™ã€‚

```ruby
# lib/loader.rb
require "pathname"

class Loader
  BASE_PATH = "/base_path"

  def file_path(name)
    Pathname.new(BASE_PATH).join(name)
  end
end

# lib/writer.rb
class Writer
  def initialize(loader)
    @loader = loader
  end

  def write(content, filename)
    path = @loader.file_path(filename)
    File.write(path, content)
  end
end

# spec/loader_spec.rb
RSpec.describe Loader do
  describe '#file_path' do
    subject { Loader.new.file_path("backup.tmp") }

    it 'returns correct path' do
      is_expected.to eq(Pathname.new("/base_path/backup.tmp"))
    end
  end
end

# spec/writer_spec.rb
RSpec.describe Writer do
  before do
    Loader::BASE_PATH = "/tmp"  # å•é¡Œã®ã‚³ãƒ¼ãƒ‰
  end

  it 'writes to temporary directory' do
    writer = Writer.new(Loader.new)
    # ãƒ†ã‚¹ãƒˆå†…å®¹
  end
end
```

ã“ã®æ™‚ `writer_spec.rb` ã¨ `loader_spec.rb` ã¯ãã‚Œãã‚Œåˆ¥ã€…ã«å®Ÿè¡Œã™ã‚‹ã¨æˆåŠŸã—ã¾ã™ãŒã€ã¾ã¨ã‚ã¦å®Ÿè¡Œã™ã‚‹ã¨å¤±æ•—ã—ã¾ã™ã€‚

| å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰                                    | çµæœ     |
|-------------------------------------------------|----------|
| `rspec spec/loader_spec.rb`                     | æˆåŠŸ     |
| `rspec spec/writer_spec.rb`                     | æˆåŠŸ     |
| `rspec spec/loader_spec.rb spec/writer_spec.rb` | æˆåŠŸ     |
| `rspec spec/writer_spec.rb spec/loader_spec.rb` | **å¤±æ•—** |

ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ä¸‹è¨˜ã®é€šã‚Šã§ã™ã€‚

```
    Failure/Error: is_expected.to eq(Pathname.new("/base_path/backup.tmp"))

       expected: #<Pathname:/base_path/backup.tmp>
            got: #<Pathname:/tmp/backup.tmp>
```

`/base_path` ã‚’æœŸå¾…ã—ã¦ã„ã‚‹ç®‡æ‰€ãŒ `/tmp` ã«å¤‰ã‚ã£ã¦ã„ã¾ã™ã€‚

### åŸå› ã¨ä¿®æ­£æ–¹æ³•

Ruby ã§ã¯å®šæ•°ã®å†ä»£å…¥ãŒå¯èƒ½ã§ã€è­¦å‘Šã¯å‡ºã‚‹ã‚‚ã®ã®å®Ÿè¡Œã¯ç¶™ç¶šã•ã‚Œã¾ã™ã€‚ã“ã®ç‰¹æ€§ã«ã‚ˆã‚Šã€ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œé †åºã«ã‚ˆã£ã¦çµæœãŒå¤‰ã‚ã‚‹ Flaky Test ãŒç™ºç”Ÿã—ã¾ã™ã€‚å•é¡Œã¨ãªã£ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ« `writer_spec.rb` ã®ä¸‹è¨˜ã®éƒ¨åˆ†ã«æ³¨ç›®ã—ã¦ãã ã•ã„ã€‚

```ruby
  before do
    Loader::BASE_PATH = "/tmp"
  end
```

ã“ã‚Œã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿é †åºã«ã‚ˆã£ã¦ã¯1å›ç›®ã® `Loader::BASE_PATH` ã®å®šç¾©ã§ã™ã€‚ã—ã‹ã—ã€äº‹å‰ã« Loader ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã‚‹å ´åˆã¯2å›ç›®ã®å®šç¾©ã¨ãªã‚Šã€1å›ç›®ã®å®šç¾©ã‚’ä¸Šæ›¸ãã—ã¦ã—ã¾ã„ã¾ã™ã€‚ã“ã®æ”¹å¤‰ã¯ã€`rspec` ã‚³ãƒãƒ³ãƒ‰ãŒçµ‚äº†ã™ã‚‹ã¾ã§ç¶™ç¶šã—ã¾ã™ã€‚ã“ã‚ŒãŒã€ãƒ†ã‚¹ãƒˆå¤±æ•—ã®åŸå› ã§ã™ã€‚

ã“ã‚Œã‚’ä¿®æ­£ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã« [stub_const](https://rspec.info/features/3-13/rspec-mocks/mutating-constants/) ã‚’ä½¿ã£ã¦ç½®ãæ›ãˆã¾ã™ã€‚

```ruby
  before do
    stub_const("Loader::BASE_PATH", "/tmp")
  end
```

stub_const ã¯ã€ãã‚Œã‚’å®£è¨€ã—ãŸã‚¹ã‚³ãƒ¼ãƒ—ã‚’å‡ºã‚‹æ™‚ã«å®šæ•°ã®ç½®ãæ›ãˆã‚’å…ƒã«æˆ»ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€è­¦å‘Šã‚’å‡ºã™ã“ã¨ãªãå®šæ•°ã‚’ç½®ãæ›ãˆã€å‰¯ä½œç”¨ã‚‚è§£æ¶ˆã§ãã¾ã™ã€‚

## äº‹ä¾‹2ï¼šã‚¯ãƒ©ã‚¹ã®å†å®šç¾©
### ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰

ä»¥ä¸‹ã®ä¾‹ã¯ã‚¯ãƒ©ã‚¹ã®å†å®šç¾©ã«ã‚ˆã£ã¦èµ·ãã‚‹ Flaky Test ã®ä¾‹ã§ã™ã€‚SimpleModule, SpecialModule ã®äºŒã¤ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒã‚ã‚Šã€ãã‚Œãã‚Œãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æŒã£ã¦ã„ã¾ã™ã€‚

```ruby
# simple_module.rb
module SimpleModule
  def to_s
    "simple!"
  end
end

# special_module.rb
module SpecialModule
  def hello
    "hello: #{self}"
  end
end

# simple_module_spec.rb
RSpec.describe "SimpleModule" do
  before do
    class Dummy
      include SimpleModule
    end
  end

  it do
    expect(Dummy.new.to_s).to eq("simple!")
  end
end

# special_module_spec.rb
RSpec.describe "SpecialModule" do
  before do
    class Dummy
      include SpecialModule
    end
  end

  it do
    expect(Dummy.new.hello).to be_start_with("hello: #<Dummy:")
  end
end
```

ã“ã®æ™‚ `simple_module_spec.rb` ã¨ `special_module_spec.rb` ã¯ãã‚Œãã‚Œåˆ¥ã€…ã«å®Ÿè¡Œã™ã‚‹ã¨æˆåŠŸã—ã¾ã™ãŒã€ã¾ã¨ã‚ã¦å®Ÿè¡Œã™ã‚‹ã¨å¤±æ•—ã—ã¾ã™ã€‚

| å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰                                         | çµæœ     |
|------------------------------------------------------|----------|
| `rspec simple_module_spec.rb`                        | æˆåŠŸ     |
| `rspec special_module_spec.rb`                       | æˆåŠŸ     |
| `rspec special_module_spec.rb simple_module_spec.rb` | æˆåŠŸ     |
| `rspec simple_module_spec.rb special_module_spec.rb` | **å¤±æ•—** |

ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ä¸‹è¨˜ã®é€šã‚Šã§ã™ã€‚

```
     Failure/Error: expect(Dummy.new.hello).to be_start_with("hello: #<Dummy:")
       expected `"hello: simple!".start_with?("hello: #<Dummy:")` to be truthy, got false
```

`Dummy` ã‚¯ãƒ©ã‚¹ã® `to_s` ã¯ `hello: #<Dummy:` ã§å§‹ã¾ã‚‹æ–‡å­—åˆ—ã§ã‚ã‚‹ã“ã¨ã‚’æœŸå¾…ã—ã¦ã„ã¾ã™ãŒ `hello: simple!` ã‚’è¿”ã—ã¦ã„ã¾ã™ã€‚

### åŸå› ã¨ä¿®æ­£æ–¹æ³•

Ruby ã§ã¯ã‚¯ãƒ©ã‚¹ã®å†å®šç¾©ã¯ã€ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã—ã¾ã›ã‚“ã€‚ã‚ªãƒ¼ãƒ—ãƒ³ã‚¯ãƒ©ã‚¹ã¨ã—ã¦æ©Ÿèƒ½ã—ã€ãƒ¡ã‚½ãƒƒãƒ‰ã®è¿½åŠ ã‚„ä¸Šæ›¸ããŒç™ºç”Ÿã—ã¾ã™ã€‚ä¸‹è¨˜ã®ã‚³ãƒ¼ãƒ‰ã«æ³¨ç›®ã—ã¦ãã ã•ã„ã€‚

```ruby
  before do
    class Dummy
      include SimpleModule
    end
  end
```

ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã¯ã‚¯ãƒ©ã‚¹ `Dummy` ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ã€ã‚¹ã‚³ãƒ¼ãƒ—ã‚’æŠœã‘ãŸå¾Œã‚‚æ®‹ã‚Šç¶šã‘ã¾ã™ã€‚ä»–ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã§åŒã˜åå‰ã®ã‚¯ãƒ©ã‚¹ `Dummy` ã‚’ä½¿ã„å›ã—ã¦ã„ã‚‹ã¨ã€ã‚¯ãƒ©ã‚¹ã‚ªãƒ¼ãƒ—ãƒ³ã‚’ç¹°ã‚Šè¿”ã—ã¦æ‹¡å¼µã™ã‚‹ã“ã¨ã«ãªã‚Šã€çµæœã¨ã—ã¦ Flaky Test ã®åŸå› ã¨ãªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

æ”¹å–„ç­–ã¨ã—ã¦ã¯åŒ¿åã‚¯ãƒ©ã‚¹ã‚’ä½¿ã„ã¾ã™ã€‚stub_const ã¨çµ„ã¿åˆã‚ã›ã‚‹ã¨ã€åŒã˜ã‚¯ãƒ©ã‚¹åã§ã‚‚ã€å®‰å…¨ã«åå‰ã¥ã‘ã§ãã¾ã™ã€‚

```ruby
RSpec.describe "SimpleModule" do
  before do
    dummy_class = Class.new do
      include SimpleModule
    end

    stub_const("Dummy", dummy_class)
  end
end
```

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€ã‚¹ã‚³ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹å‰ã« Dummy ã‚¯ãƒ©ã‚¹ã¯å‰Šé™¤ã•ã‚Œã€å‰¯ä½œç”¨ã‚’ä¸ãˆã¾ã›ã‚“ã€‚

## äºŒåˆ†æ¢ç´¢ã‚’ä½¿ã£ã¦å‰¯ä½œç”¨ã‚’ä¸ãˆã¦ã„ã‚‹çŠ¯äººã‚’æ¢ã™

ä¾‹ãˆã°ä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦100å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ†ã‚¹ãƒˆã—ãŸã¨ã—ã¾ã™ã€‚

```
rspec test001.rb test002.rb ... çœç•¥ ... test099.rb test100.rb
```

ã“ã®æ™‚ test100.rb ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚test100.rb ã‚’å¤±æ•—ã•ã›ã‚‹çŠ¯äººã¯ã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã—ã‚‡ã†ã‹ã€‚1ãƒ•ã‚¡ã‚¤ãƒ«ãšã¤å®Ÿè¡Œã™ã‚‹ã¨æˆåŠŸã™ã‚‹ã“ã¨ã¯ç¢ºèªæ¸ˆã¿ã¨ã—ã¾ã™ã€‚ç´ æœ´ãªã‚¢ã‚¤ãƒ‡ã‚¢ã¨ã—ã¦ã€ä¸‹è¨˜ã®ã‚ˆã†ã«100å€‹ã«åˆ†å‰²å®Ÿè¡Œã™ã‚‹æ‰‹ãŒã‚ã‚Šã¾ã™ã€‚

```
rspec test001.rb test100.rb
rspec test002.rb test100.rb
rspec test003.rb test100.rb
... çœç•¥ ...
rspec test098.rb test100.rb
rspec test099.rb test100.rb
```

ã‚³ãƒãƒ³ãƒ‰ã®ã„ãšã‚Œã‹1ã¤å¤±æ•—ã—ãŸãªã‚‰ã°ã€å‰¯ä½œç”¨ã‚’ä¸ãˆã¦ã„ã‚‹çŠ¯äººã¯ç¢ºå®šã§ãã¾ã™ã€‚ã“ã®æ–¹æ³•ã®å¼±ç‚¹ã¯ã€æ‰‹é–“ãŒã‹ã‹ã‚‹ã“ã¨ã§ã™ã€‚ã¾ãŸã€çŠ¯äººãŒ3å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®çµ„ã¿åˆã‚ã›ã ã£ãŸå ´åˆã«ã¯è¿·å®®å…¥ã‚Šã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

ã‚ˆã‚Šã‚¹ãƒãƒ¼ãƒˆãªæ–¹æ³•ã¨ã—ã¦ã¯äºŒåˆ†æ¢ç´¢ã‚’ä½¿ã†æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚æœ€åˆã«ã€ä¸‹è¨˜ã®2ã¤ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```
rspec test001.rb test002.rb ... çœç•¥ ... test50.rb test100.rb
rspec test051.rb test052.rb ... çœç•¥ ... test99.rb test100.rb
```

æˆåŠŸã—ãŸã‚³ãƒãƒ³ãƒ‰ã«å«ã¾ã‚Œã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¯ç„¡ç½ªã§ã™ã€‚å¤±æ•—ã—ãŸã‚³ãƒãƒ³ãƒ‰ã«å«ã¾ã‚Œã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒå®¹ç–‘è€…ã¨ãªã‚Šã¾ã™ã€‚ã“ã‚Œã‚’ã•ã‚‰ã«åŠåˆ†ã«åˆ†å‰²ã—ã¾ã™ã€‚åŒã˜ã“ã¨ã‚’ç¹°ã‚Šè¿”ã—ã¦ã„ã‘ã°ã€ã‚ãšã‹ãªå›æ•°ã§çŠ¯äººã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚äºŒåˆ†æ¢ç´¢ã¯å®Œç’§ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€è¤‡æ•°çŠ¯ã®å ´åˆã§ã‚‚ã€ã‚ã‚‹ç¨‹åº¦æ©Ÿèƒ½ã—ã¾ã™ã€‚

## ãŠã‚ã‚Šã«

Flaky Test ãŒç™ºç”Ÿã™ã‚‹å…·ä½“çš„ãªäº‹ä¾‹ã‚’ç´¹ä»‹ã—ã€ã‚ˆã‚Šç¾å®Ÿçš„ãªãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã¨ã—ã¦äºŒåˆ†æ¢ç´¢ã‚’ä½¿ã£ãŸ Flaky Test ã®èª¿æŸ»æ–¹æ³•ã«ã¤ã„ã¦ã‚‚ç´¹ä»‹ã—ã¾ã—ãŸã€‚ã—ã‹ã—ã€é †åºä»¥å¤–ã®åŸå› ãŒæ½œã‚“ã§ã„ã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã° [parallel_test](https://github.com/grosser/parallel_tests) ãŒåŸå› ã ã£ãŸã¨ã„ã†ã‚±ãƒ¼ã‚¹ã‚‚ã‚ã‚Šã¾ã™ã€‚

Flaky Test ã¯ã„ãã‚‰èª¿ã¹ã¦ã‚‚å†ç¾ã›ãšã€ç³¸å£ã•ãˆæ´ã‚ãªã„ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚ã©ã†ã—ã¦ã‚‚è§£æ±ºã§ããªã„å ´åˆã¯ã€è«¦ã‚ã‚‹ã“ã¨ã‚‚æ¤œè¨ã—ã¾ã—ã‚‡ã†ã€‚ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ®‹ã—ã¤ã¤ã€ã‚¹ã‚¿ãƒ–ã‚’ä½¿ã£ã¦å®‰å®šã•ã›ã‚‹ã€ãƒšãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã™ã‚‹ã€ã¨ã„ã£ãŸé€ƒã’é“ã‚‚ã‚ã‚Šã¾ã™ã€‚ã‚‚ã—ãƒãƒ¼ãƒ ã§Flaky Testã«æ‚©ã¾ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ã“ã®è¨˜äº‹ã§ç´¹ä»‹ã—ãŸæ‰‹æ³•ã‚’ä½¿ã£ã¦ã€è§£æ±ºã«å–ã‚Šçµ„ã‚“ã§ã¿ã¦ãã ã•ã„ã€‚
